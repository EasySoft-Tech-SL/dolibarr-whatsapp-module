name: Build Module Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, json
      
      - name: Extract module version
        id: version
        run: |
          # Extraer versi√≥n directamente del archivo usando grep y regex
          # Soporta formatos: 'X.X', 'X.X.X', "X.X", "X.X.X"
          VERSION=$(grep -oP "\\\$this->version\s*=\s*['\"]([0-9]+\.[0-9]+(\.[0-9]+)?)['\"]" core/modules/modWhatsapp.class.php | grep -oP "[0-9]+\.[0-9]+(\.[0-9]+)?")
          
          # Validar que la versi√≥n tiene formato X.X o X.X.X
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
              echo "Error: Invalid version format: $VERSION"
              exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Module version detected: $VERSION"
      
      - name: Create module archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCHIVE_NAME="module_whatsapp-${VERSION}.zip"
          
          echo "Creating archive: $ARCHIVE_NAME"
          
          # Crear directorio temporal con la estructura deseada
          mkdir -p temp_build/whatsapp
          
          # Copiar todos los archivos al directorio whatsapp, excluyendo archivos innecesarios
          rsync -av --exclude='.git' \
            --exclude='.github' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            --exclude='Thumbs.db' \
            --exclude='*.log' \
            --exclude='temp_build' \
            --exclude='test' \
            --exclude='phpunit.xml' \
            --exclude='.editorconfig' \
            ./ temp_build/whatsapp/
          
          # Crear el archivo zip desde el directorio temporal
          cd temp_build
          zip -r "../$ARCHIVE_NAME" whatsapp
          cd ..
          
          # Limpiar directorio temporal
          rm -rf temp_build
          
          # Verificar que el archivo se cre√≥ correctamente
          if [ ! -f "$ARCHIVE_NAME" ]; then
              echo "Error: Archive was not created"
              exit 1
          fi
          
          # Mostrar informaci√≥n del archivo
          ls -lh "$ARCHIVE_NAME"
          
          # Verificar estructura del zip
          echo "Archive structure:"
          unzip -l "$ARCHIVE_NAME" | head -30
          
          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
        id: archive
      
      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extraer la secci√≥n del changelog para esta versi√≥n
          CHANGELOG=$(awk "/^## $VERSION /,/^## [0-9]/" ChangeLog.md | sed '$d' | tail -n +2)
          
          # Si no se encuentra changelog espec√≠fico, usar mensaje por defecto
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No changelog available for this version."
          fi
          
          # Guardar en variable de entorno usando heredoc para manejar multilinea
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: module_whatsapp-${{ steps.version.outputs.version }}
          path: module_whatsapp-${{ steps.version.outputs.version }}.zip
          retention-days: 90
          if-no-files-found: error
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## WhatsApp Module v${{ steps.version.outputs.version }}
            
            Versi√≥n compilada autom√°ticamente desde la rama principal.
            
            ### üì¶ Instalaci√≥n
            1. Descargar el archivo `module_whatsapp-${{ steps.version.outputs.version }}.zip`
            2. Descomprimir en `custom/whatsapp/` de tu instalaci√≥n de Dolibarr
            3. Activar el m√≥dulo desde el panel de administraci√≥n
            
            ### üìã Cambios en esta versi√≥n
            ${{ steps.changelog.outputs.changelog }}
            
            ### ‚ÑπÔ∏è Informaci√≥n del Build
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref_name }}
            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            
            ---
            
            Ver [ChangeLog.md](https://github.com/${{ github.repository }}/blob/main/ChangeLog.md) completo para m√°s detalles.
          files: module_whatsapp-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCHIVE_NAME="module_whatsapp-${VERSION}.zip"
          ARCHIVE_SIZE=$(ls -lh "$ARCHIVE_NAME" | awk '{print $5}')
          
          echo "## üì¶ Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive**: $ARCHIVE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $ARCHIVE_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ WhatsApp module compiled and ready for distribution" >> $GITHUB_STEP_SUMMARY
